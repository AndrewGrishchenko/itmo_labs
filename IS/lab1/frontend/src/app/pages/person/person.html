<div class="header-controls">
  <button mat-raised-button color="primary" (click)="openDialog()">Создать</button>
  <mat-checkbox [(ngModel)]="showOnlyMine" (change)="onFilterChange()">Показать только мои</mat-checkbox>
</div>
<div class="table-wrapper">
  <div *ngIf="isLoading" class="spinner-overlay"><mat-spinner></mat-spinner></div>
  
  <div class="table-container mat-elevation-z8">
    <div [formGroup]="filterForm">
      <table mat-table [dataSource]="dataSource" matSort>
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="id">ID</div>
            <mat-form-field class="filter-field">
              <input matInput formControlName="id" (click)="$event.stopPropagation()">
            </mat-form-field>
          </th>
          <td mat-cell *matCellDef="let row"> {{row.id}} </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="name">Название</div>
            <mat-form-field class="filter-field">
              <input matInput formControlName="name" (click)="$event.stopPropagation()">
            </mat-form-field>
          </th>
          <td mat-cell *matCellDef="let row"> {{row.name}} </td>
        </ng-container>

        <ng-container matColumnDef="weight">
          <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="weight">Вес</div>
            <mat-form-field class="filter-field">
              <input matInput formControlName="weight" (click)="$event.stopPropagation()">
            </mat-form-field>
          </th>
          <td mat-cell *matCellDef="let row"> {{row.weight}} </td>
        </ng-container>
        
        <ng-container matColumnDef="eyeColor">
          <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="eyeColor">Цвет глаз</div>
            
            <mat-form-field class="filter-field">
              <mat-select formControlName="eyeColor" placeholder="Все">
                <mat-option [value]="null">Все</mat-option>
                <mat-option *ngFor="let color of eyeColors" [value]="color">
                  {{ color }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            
          </th>
          <td mat-cell *matCellDef="let row"> {{ row.eyeColor || '—' }} </td>
        </ng-container>

        <ng-container matColumnDef="hairColor">
          <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="hairColor">Цвет волос</div>
            <mat-form-field class="filter-field">
              <mat-select formControlName="hairColor" placeholder="Все">
                <mat-option [value]="null">Все</mat-option>
                <mat-option *ngFor="let color of hairColors" [value]="color">
                  {{ color }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </th>
          <td mat-cell *matCellDef="let row"> {{ row.hairColor || '—' }} </td>
        </ng-container>

        <ng-container matColumnDef="nationality">
          <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="nationality">Национальность</div>
            <mat-form-field class="filter-field">
              <mat-select formControlName="nationality" placeholder="Все">
                <mat-option [value]="null">Все</mat-option>
                <mat-option *ngFor="let nationality of nationalities" [value]="nationality">
                  {{ nationality }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </th>
          <td mat-cell *matCellDef="let row"> {{ row.nationality || '—' }} </td>
        </ng-container>

        <ng-container matColumnDef="location">
          <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="location.name">Локация</div>
            <div class="picker-filter-container">
              <button mat-stroked-button class="picker-button" (click)="openLocationFilterSelector()"
                      [disabled]="filterForm.get('location')?.disabled">
                {{ filterForm.get('location')?.value?.name || 'Выбрать...' }}
              </button>
              <button *ngIf="filterForm.get('location')?.value && !isFilterLocked"
                mat-icon-button class="clear-button" (click)="clearLocationFilter($event)">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </th>
          <td mat-cell *matCellDef="let row"
              [ngClass]="{'highlight-conflict': conflictingEntityId !== null && row.location?.id === conflictingEntityId}">
            {{ row.location?.name || '—' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="owner">
          <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="owner.username">Владелец</div>
            <div class="picker-filter-container">
              <button mat-stroked-button class="picker-button" (click)="openOwnerFilterSelector()">
                {{ filterForm.get('owner')?.value?.username || 'Выбрать...' }}
              </button>
              <button *ngIf="filterForm.get('owner')?.value"
                mat-icon-button class="clear-button" (click)="clearOwnerFilter($event)">
                <mat-icon>close</mat-icon>  
              </button>
            </div>
          </th>
          <td mat-cell *matCellDef="let row"> {{row.owner.username}} </td>
        </ng-container>
        
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="openDialog(row)" class="clickable-row" [ngClass]="{'not-my-row': row.owner?.id !== currentUserId}"></tr>
        <tr class="mat-row" *matNoDataRow><td class="mat-cell" [attr.colspan]="displayedColumns.length">Нет данных.</td></tr>
      </table>
    </div>
    <mat-paginator [length]="resultsLength" [pageSize]="10" [pageSizeOptions]="[5, 10, 25, 100]"></mat-paginator>
  </div>
</div>