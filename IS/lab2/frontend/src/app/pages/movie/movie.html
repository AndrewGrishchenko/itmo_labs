<div class="header-controls">
  <button mat-raised-button color="primary" (click)="openDialog()">Создать</button>
  <button mat-raised-button color="primary" (click)="import()">Импорт</button>
  <mat-checkbox [(ngModel)]="showOnlyMine" (change)="onFilterChange()">Показать только мои</mat-checkbox>
</div>
<div class="table-wrapper">
  <div *ngIf="isLoading" class="spinner-overlay"><mat-spinner></mat-spinner></div>

  <div class="table-container mat-elevation-z8">
    <div [formGroup]="filterForm">
        <table mat-table [dataSource]="dataSource" matSort>

        <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="id">ID</div>
            <mat-form-field class="filter-field">
                <input matInput formControlName="id" (click)="$event.stopPropagation()">
            </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let row"> {{row.id}} </td>
        </ng-container>

        <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="name">Название</div>
            <mat-form-field class="filter-field">
                <input matInput formControlName="name" (click)="$event.stopPropagation()">
            </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let row"> {{row.name}} </td>
        </ng-container>

        <ng-container matColumnDef="coordinates">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="coordinates.id">Координаты id</div>
            <div class="picker-filter-container">
                <button mat-stroked-button class="picker-button" (click)="openCoordinatesFilterSelector()"
                        [disabled]="filterForm.get('coordinates')?.disabled">
                {{ filterForm.get('coordinates')?.value?.name || 'Выбрать...' }}
                </button>
                <button *ngIf="filterForm.get('coordinates')?.value && !isFilterLocked"
                mat-icon-button class="clear-button" (click)="clearCoordinatesFilter($event)">
                <mat-icon>close</mat-icon>
                </button>
            </div>
            </th>
            <td mat-cell *matCellDef="let row"
                [ngClass]="{'highlight-conflict': conflictingEntityId !== null && row.coordinates?.id === conflictingEntityId}">
                {{ row.coordinates.id }}
            </td>
        </ng-container>

        <ng-container matColumnDef="creationDate">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="creationDate">creationDate</div>
            <mat-form-field class="filter-field">
                <input matInput formControlName="creationDate" (click)="$event.stopPropagation()">
            </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let row"> {{row.creationDate}} </td>
        </ng-container>

        <ng-container matColumnDef="oscarsCount">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="oscarsCount">Количество оскаров</div>
            <mat-form-field class="filter-field">
                <input matInput formControlName="oscarsCount" (click)="$event.stopPropagation()">
            </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let row"> {{row.oscarsCount}} </td>
        </ng-container>

        <ng-container matColumnDef="budget">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="budget">Бюджет</div>
            <mat-form-field class="filter-field">
                <input matInput formControlName="budget" (click)="$event.stopPropagation()">
            </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let row"> {{row.budget}} </td>
        </ng-container>

        <ng-container matColumnDef="totalBoxOffice">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="totalBoxOffice">Касса</div>
            <mat-form-field class="filter-field">
                <input matInput formControlName="totalBoxOffice" (click)="$event.stopPropagation()">
            </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let row"> {{row.totalBoxOffice}} </td>
        </ng-container>

        <ng-container matColumnDef="mpaaRating">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="mpaaRating">Рейтинг</div>
            <mat-form-field class="filter-field">
                <mat-select formControlName="mpaaRating" placeholder="Все">
                <mat-option [value]="null">Все</mat-option>
                <mat-option *ngFor="let mpaaRating of mpaaRatings" [value]="mpaaRating">
                    {{ mpaaRating }}
                </mat-option>
                </mat-select>
            </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let row"> {{ row.mpaaRating || '—' }} </td>
        </ng-container>

        <ng-container matColumnDef="director">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="director.name">Директор</div>
            <div class="picker-filter-container">
                <button mat-stroked-button class="picker-button" (click)="openDirectorFilterSelector()"
                        [disabled]="filterForm.get('director')?.disabled">
                {{ filterForm.get('director')?.value?.name || 'Выбрать...' }}
                </button>
                <button *ngIf="filterForm.get('director')?.value && !isFilterLocked"
                mat-icon-button class="clear-button" (click)="clearDirectorFilter($event)">
                <mat-icon>close</mat-icon>
                </button>
            </div>
            </th>
            <td mat-cell *matCellDef="let row"
                [ngClass]="{'highlight-conflict': conflictingEntityId !== null && row.director?.id === conflictingEntityId}">
                {{ row.director?.name || '-' }}
            </td>
        </ng-container>

        <ng-container matColumnDef="screenwriter">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="screenwriter.name">Сценарист</div>
            <div class="picker-filter-container">
                <button mat-stroked-button class="picker-button" (click)="openScreenwriterFilterSelector()"
                        [disabled]="filterForm.get('screenwriter')?.disabled">
                {{ filterForm.get('screenwriter')?.value?.name || 'Выбрать...' }}
                </button>
                <button *ngIf="filterForm.get('screenwriter')?.value && !isFilterLocked"
                mat-icon-button class="clear-button" (click)="clearScreenwriterFilter($event)">
                <mat-icon>close</mat-icon>
                </button>
            </div>
            </th>
            <td mat-cell *matCellDef="let row"
                [ngClass]="{'highlight-conflict': conflictingEntityId !== null && row.screenwriter?.id === conflictingEntityId}">
                {{ row.screenwriter?.name || '-' }}
            </td>
        </ng-container>

        <ng-container matColumnDef="operator">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="operator.name">Оператор</div>
            <div class="picker-filter-container">
                <button mat-stroked-button class="picker-button" (click)="openOperatorFilterSelector()"
                        [disabled]="filterForm.get('operator')?.disabled">
                {{ filterForm.get('operator')?.value?.name || 'Выбрать...' }}
                </button>
                <button *ngIf="filterForm.get('operator')?.value && !isFilterLocked"
                mat-icon-button class="clear-button" (click)="clearOperatorFilter($event)">
                <mat-icon>close</mat-icon>
                </button>
            </div>
            </th>
            <td mat-cell *matCellDef="let row"
                [ngClass]="{'highlight-conflict': conflictingEntityId !== null && row.operator?.id === conflictingEntityId}">
                {{ row.operator.name }}
            </td>
        </ng-container>

        <ng-container matColumnDef="length">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="length">Длина</div>
            <mat-form-field class="filter-field">
                <input matInput formControlName="length" (click)="$event.stopPropagation()">
            </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let row"> {{row.length}} </td>
        </ng-container>

        <ng-container matColumnDef="goldenPalmCount">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="goldenPalmCount">Количество золотых пальм</div>
            <mat-form-field class="filter-field">
                <input matInput formControlName="goldenPalmCount" (click)="$event.stopPropagation()">
            </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let row"> {{row.goldenPalmCount}} </td>
        </ng-container>

        <ng-container matColumnDef="genre">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="genre">Жанр</div>
            <mat-form-field class="filter-field">
                <mat-select formControlName="genre" placeholder="Все">
                <mat-option [value]="null">Все</mat-option>
                <mat-option *ngFor="let genre of genres" [value]="genre">
                    {{ genre }}
                </mat-option>
                </mat-select>
            </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let row"> {{ row.genre || '—' }} </td>
        </ng-container>

        <ng-container matColumnDef="owner">
            <th mat-header-cell *matHeaderCellDef>
            <div mat-sort-header="owner.username">Владелец</div>
            <div class="picker-filter-container">
                <button mat-stroked-button class="picker-button" (click)="openOwnerFilterSelector()">
                {{ filterForm.get('owner')?.value?.username || 'Выбрать...' }}
                </button>
                <button *ngIf="filterForm.get('owner')?.value"
                mat-icon-button class="clear-button" (click)="clearOwnerFilter($event)">
                <mat-icon>close</mat-icon>  
                </button>
            </div>
            </th>
            <td mat-cell *matCellDef="let row"> {{row.owner.username}} </td>
        </ng-container>
        
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="openDialog(row)" class="clickable-row" [ngClass]="{'not-my-row': row.owner?.id !== currentUserId}"></tr>
        <tr class="mat-row" *matNoDataRow><td class="mat-cell" [attr.colspan]="displayedColumns.length">Нет данных.</td></tr>
        </table>
    </div>
    <mat-paginator [length]="resultsLength" [pageSize]="10" [pageSizeOptions]="[5, 10, 25, 100]"></mat-paginator>
  </div>
</div>